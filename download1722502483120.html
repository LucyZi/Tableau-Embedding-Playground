<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My embedded Tableau vizualization</title>
    <style>
      html, body, tableau-viz, tableau-authoring-viz {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <tableau-viz
      src="https://public.tableau.com/views/DeveloperSuperstore/Overview"
      device="desktop"
      hide-tabs
      toolbar="hidden"
    >
    </tableau-viz>
    <script type="module">
      import { SheetType, TableauEventType } from 'https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.js';
      (async () => {
        // 定义多个 dashboard 的 URL
        const dashboards = [
          { name: 'Dashboard 1', url: 'https://public.tableau.com/views/US_regrouped_layer1/HBMCataGlance_map?:language=en-US&:sid=&:redirect=auth&:display_count=n&:origin=viz_share_link' },
          { name: 'Dashboard 2', url: 'https://public.tableau.com/views/US_regrouped_layer2/HBMCataGlance_map?:language=en-US&:sid=&:redirect=auth&:display_count=n&:origin=viz_share_link' },
          { name: 'Dashboard 3', url: 'https://public.tableau.com/views/IL-Cook/HBMCataGlance_map?:language=en-US&:sid=&:redirect=auth&:display_count=n&:origin=viz_share_link' }
        ];

        // 创建布局和样式
        function createLayout() {
          // 创建样式
          const style = document.createElement('style');
          style.textContent = `
            body, html {
              margin: 0;
              padding: 0;
              height: 100%;
              overflow: hidden;
              font-family: Arial, sans-serif;
            }
            #app {
              display: flex;
              height: 100vh;
            }
            #sidebar {
              width: 200px;
              background-color: #f0f0f0;
              padding: 20px;
              box-shadow: 2px 0 5px rgba(0,0,0,0.1);
              overflow-y: auto;
            }
            #content {
              flex-grow: 1;
              overflow: hidden;
              display: flex;
              flex-direction: column;
            }
            .nav-button {
              display: block;
              width: 100%;
              padding: 10px;
              margin-bottom: 10px;
              background-color: #e0e0e0;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              transition: background-color 0.3s;
            }
            .nav-button:hover {
              background-color: #d0d0d0;
            }
            .nav-button.active {
              background-color: #007bff;
              color: white;
            }
            #viz-container {
              flex-grow: 1;
              position: relative;
            }
            tableau-viz {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
            }
            ::-webkit-scrollbar {
              width: 0px;
              background: transparent;
            }
            .tab-zone, .tab-widget, .wcLayoutContainer, .tabZone-layout-flow {
              height: 20px !important;
              overflow: hidden !important;
            }
          `;
          document.head.appendChild(style);

          // 创建 DOM 结构
          const app = document.createElement('div');
          app.id = 'app';

          const sidebar = document.createElement('div');
          sidebar.id = 'sidebar';

          const content = document.createElement('div');
          content.id = 'content';

          const vizContainer = document.createElement('div');
          vizContainer.id = 'viz-container';

          content.appendChild(vizContainer);
          app.appendChild(sidebar);
          app.appendChild(content);

          // 将原有的 tableau-viz 元素移动到新的容器中
          const tableauViz = document.querySelector('tableau-viz');
          vizContainer.appendChild(tableauViz);

          // 将新创建的结构添加到 body
          document.body.insertBefore(app, document.body.firstChild);
        }

        // 创建导航按钮
        function createNavigation() {
          const sidebar = document.getElementById('sidebar');
          dashboards.forEach((dashboard, index) => {
            const button = document.createElement('button');
            button.textContent = dashboard.name;
            button.className = 'nav-button';
            button.onclick = () => loadDashboard(index);
            sidebar.appendChild(button);
          });
        }

        // 设置活动按钮样式
        function setActiveButton(index) {
          const buttons = document.querySelectorAll('.nav-button');
          buttons.forEach((button, i) => {
            button.classList.toggle('active', i === index);
          });
        }

        // 调整 tab-zone 的高度
        function adjustTabZoneHeight() {
          const tabZones = document.querySelectorAll('.tab-zone, .tab-widget, .wcLayoutContainer, .tabZone-layout-flow');
          tabZones.forEach(tabZone => {
            tabZone.style.setProperty('height', '20px', 'important');
            tabZone.style.setProperty('overflow', 'hidden', 'important');
          });
        }

        // 创建 MutationObserver 来监视 DOM 变化
        function createTabZoneObserver() {
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' || mutation.type === 'attributes') {
                adjustTabZoneHeight();
              }
            });
          });

          const config = { childList: true, subtree: true, attributes: true, attributeFilter: ['style'] };
          observer.observe(document.body, config);
        }

        // 加载指定的 dashboard
        async function loadDashboard(index) {
          try {
            const viz = document.querySelector('tableau-viz');
            viz.src = dashboards[index].url;

            // 设置 token（如果需要）
            viz.token = window.token;

            // 设置 viz 的大小以填满容器
            viz.style.width = '100%';
            viz.style.height = '100%';

            // 等待 viz 变为可交互
            await new Promise((resolve, reject) => {
              viz.addEventListener(TableauEventType.FirstInteractive, () => {
                console.log('Viz is interactive!');
                resolve();
              });

              viz.addEventListener(TableauEventType.VizLoadError, (error) => {
                const message = JSON.parse(error.detail.message);
                const errorMessage = JSON.parse(message.errorMessage);
                const displayMessage = `ca-error-${errorMessage.result.errors[0].code}`;
                reject(displayMessage);
              });
            });

            // 设置活动按钮
            setActiveButton(index);

            // 调整 tab-zone 高度
            adjustTabZoneHeight();

            // 在这里可以添加额外的逻辑，比如获取工作表等
            if (viz.workbook) {
              const activeSheet = viz.workbook.activeSheet;
              if (activeSheet.sheetType === SheetType.Dashboard) {
                console.log('Current sheet is a dashboard');
                // 可以在这里添加与 dashboard 相关的逻辑
              } else {
                console.log('Current sheet is a worksheet');
                // 可以在这里添加与工作表相关的逻辑
              }
            }

          } catch (error) {
            console.error('Error loading dashboard:', error);
            // 显示用户友好的错误消息
            alert(`Failed to load dashboard. Please try again later. Error: ${error}`);
          }
        }

        // 初始化函数
        function init() {
          createLayout();
          createNavigation();
          createTabZoneObserver();
          loadDashboard(0); // 加载第一个 dashboard
        }

        // 调用初始化函数
        init();
      })();
    </script>  
  </body>
</html>